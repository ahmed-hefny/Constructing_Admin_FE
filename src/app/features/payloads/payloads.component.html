<div class="page">
  <div class="page-header">
    <div class="flex items-center">
      <button class="btn btn-outline border-0" (click)="navigateBack()">
        <i class="pi pi-angle-right text-2xl"></i>
      </button>
      <h1 class="page-header-title page-title">
        الحمولات المرفوعة @if(project) { - {{ project.name }}
        }
      </h1>
    </div>
    @if(shouldShowCreateButton && !payloadsPerProject) {
    <button class="btn btn-primary" (click)="create()">
      <i class="pi pi-plus"></i>
      <span>جديد</span>
    </button>
    }
  </div>
  <div class="page-content">
    <p-card class="p-0">
      <!-- Filter Form -->
      <div class="mb-4">
        <form [formGroup]="inputForm" class="input-form">
          <!-- Date From Input -->
          <div class="form-field">
            <div class="field">
              <label for="dateFrom" class="field-label">من تاريخ</label>
              <p-calendar
                inputId="dateFrom"
                formControlName="dateFrom"
                dateFormat="dd/mm/yy"
                [maxDate]="todayMaxDate"
                placeholder="اختر التاريخ"
                styleClass="w-full"
                [showIcon]="true"
                iconDisplay="input"
                readonlyInput
                inputStyleClass="cursor-pointer"
              />
            </div>
          </div>

          <!-- Date To Input -->
          <div class="form-field">
            <div class="field">
              <label for="dateTo" class="field-label">إلى تاريخ</label>
              <p-calendar
                inputId="dateTo"
                formControlName="dateTo"
                dateFormat="dd/mm/yy"
                [maxDate]="todayMaxDate"
                placeholder="اختر التاريخ"
                styleClass="w-full"
                [showIcon]="true"
                iconDisplay="input"
                readonlyInput
                inputStyleClass="cursor-pointer"
              />
            </div>
          </div>
          <!-- Policy Number Input -->
          <div class="form-field">
            <div class="field">
              <label for="policyNumber" class="field-label">رقم البوليصة</label>
              <input
                pInput
                id="policyNumber"
                type="text"
                formControlName="policyNumber"
                placeholder="أدخل رقم البوليصة"
                class="w-full py-3"
              />
            </div>
          </div>

          <!-- Apply Button -->
          <div class="form-actions">
            <button
              pButton
              type="submit"
              class="btn btn-primary"
              size="large"
              label="تنفيذ"
              [loading]="isLoading"
              (click)="onApplyFilter()"
            ></button>
            @if(shouldShowExportButton) {
            <button
              pButton
              type="submit"
              class="btn btn-accent"
              size="large"
              label="تحميل اكسيل"
              [loading]="isExporting"
              (click)="export()"
            ></button>
            }
            <button
              pButton
              type="submit"
              class="btn btn-primary"
              size="large"
              label="استعراض"
              [loading]="isLoading"
              [disabled]="policyNumberImages.length === 0"
              (click)="openGallery()"
            ></button>
          </div>
        </form>
      </div>
      <!-- Table -->
      <p-table
        [value]="data"
        [responsiveLayout]="'scroll'"
        styleClass="p-datatable-striped mt-10"
        [scrollable]="true"
      >
        <ng-template pTemplate="header">
          <tr>
            <th class="company-name-cell">الشركة</th>
            <th>التاريخ</th>
            <th>تم التعديل</th>
            <th>رقم البوليصة</th>
            <th>الكمية</th>
            @if(!payloadsPerProject) {
            <th *appAccessControl="[SystemRoles.ADMIN, SystemRoles.Supervisor]">
              الإجراءات
            </th>
            }
          </tr>
        </ng-template>
        <ng-template pTemplate="body" let-item>
          <tr [ngClass]="{ 'bg-red-50': item?.isManual }">
            <td class="company-name-cell">{{ item?.company || "غير معرف" }}</td>
            <td>{{ item.date | date : "dd/MM/yyyy" }}</td>
            <td class="ps-12 ">
              @if (item?.isModified) {
                <i class="pi pi-check-circle text-green-500 text-xl"></i>
              } @else {
                -
              }
            </td>
            <td class="flex gap-2" [ngClass]="{ 'items-center': item.image }">
              <p-image
                [src]="item.image"
                class="min-w-10"
                imageClass="rounded-lg w-10 h-10"
                [alt]="item.policyNumber"
                [preview]="item.image ? true : false"
              />
              {{ item.policyNumber || "-" }}
            </td>
            <td>{{ item.quantity || 0 }}</td>
            @if(!payloadsPerProject) {
            <td *appAccessControl="[SystemRoles.ADMIN, SystemRoles.Supervisor]">
              <div class="flex gap-10">
                <button
                  class="btn btn-outline border-0"
                  (click)="edit(item.id)"
                >
                  <i class="pi pi-pencil ca-text-info ca-font-bold"></i>
                </button>
                <button
                  class="btn btn-outline border-0"
                  (click)="confirmDelete(item)"
                >
                  <i class="pi pi-trash ca-text-error ca-font-bold"></i>
                </button>
              </div>
            </td>
            }
          </tr>
        </ng-template>
        <ng-template pTemplate="empty">
          <tr>
            <td colspan="3" class="text-center">لم يتم العثور على مستخدمين.</td>
          </tr>
        </ng-template>
      </p-table>
      <app-pagination
        [paginationConfig]="pagination"
        (onPageChange)="onPageChange($event)"
      />
    </p-card>
  </div>
</div>

<p-dialog
  header="عرض صور البوليصات"
  [modal]="true"
  [(visible)]="visible"
  [dismissableMask]="true"
  [closable]="true"
  styleClass="dialog-container"
>
  <p-galleria
    [value]="policyNumberImages"
    containerClass="max-w-full"
    [numVisible]="5"
    [circular]="true"
    [showItemNavigators]="true"
    [showThumbnails]="false"
  >
    <ng-template pTemplate="item" let-item>
      <img [src]="item" class="gallery-image" />
    </ng-template>
  </p-galleria>
</p-dialog>
